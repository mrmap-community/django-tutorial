

<!DOCTYPE html>
<html class="writer-html5" lang="de" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kartenansicht &mdash; GeoDjango Tutorial 0.1 Dokumentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5a7626eb"></script>
      <script src="_static/doctools.js?v=9a2dae69"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/translations.js?v=79cc9f76"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Stichwortverzeichnis" href="genindex.html" />
    <link rel="search" title="Suche" href="search.html" />
    <link rel="next" title="Zusammenfassung" href="result.html" />
    <link rel="prev" title="XPlanung GML Export" href="export_xml_1.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            GeoDjango Tutorial
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Dokumentation durchsuchen" aria-label="Dokumentation durchsuchen" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Einführung</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Einführung</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#weitere-informationen">Weitere Informationen</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#beispielimplementierungen">Beispielimplementierungen</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#leitfaden">Leitfäden</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Vorarbeiten</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation der Python Umgebung</a></li>
<li class="toctree-l1"><a class="reference internal" href="initialize_project.html">Django Projekt initialisieren (Standard-Terminal oder VSCODE-Terminal)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Rahmen für Anwendung</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="first_steps.html">Erste Schritte</a></li>
<li class="toctree-l1"><a class="reference internal" href="first_templates.html">Erstellung erster Versionen der Templates</a></li>
<li class="toctree-l1"><a class="reference internal" href="add_login_register.html">Nutzung von Standardfunktionen des auth packages für Anmeldung und Registrierung</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Responsive Design</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="make_nicer.html">Integration von bootstrap5</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Datenmodelle</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="model_prerequisites.html">Vorbereitung</a></li>
<li class="toctree-l1"><a class="reference internal" href="organization_model.html">Organisationsmodell</a></li>
<li class="toctree-l1"><a class="reference internal" href="plan_model.html">Planmodell</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Optimieren der Views</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="optimize_views.html">Geometrie Editor</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimize_views.html#tabellenanzeige">Tabellenanzeige</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimize_views.html#anpassung-templates">Anpassung Templates</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Leaflet Konfiguration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="leaflet_conf.html">Zentrale Konfiguration</a></li>
<li class="toctree-l1"><a class="reference internal" href="leaflet_conf.html#wms-layer-hinzufugen">WMS Layer hinzufügen</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Export XPlanung</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="export_xml_1.html">XPlanung GML Export</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Kartenansicht und Filter</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Kartenansicht</a></li>
<li class="toctree-l1"><a class="reference internal" href="#suche">Suche</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#installation-django-filter">Installation django-filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#erstellen-einer-filter-klasse">Erstellen einer Filter Klasse</a></li>
<li class="toctree-l2"><a class="reference internal" href="#anpassen-des-views">Anpassen des Views</a></li>
<li class="toctree-l2"><a class="reference internal" href="#anzeige-der-filterfunktionen-im-template">Anzeige der Filterfunktionen im template</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Ergebnis</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="result.html">Zusammenfassung</a></li>
<li class="toctree-l1"><a class="reference internal" href="result.html#todos">TODOs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">GeoDjango Tutorial</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Kartenansicht</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/map_view.md.txt" rel="nofollow"> Quelltext anzeigen</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="kartenansicht">
<h1>Kartenansicht<a class="headerlink" href="#kartenansicht" title="Link to this heading"></a></h1>
<p>Bei der Liste der Bebauungspläne macht es Sinn sich die Lage der Pläne auch auf einer dynamischen Übersichtskarte anzeigen zu lassen. Hierzu kann django-leaflet genutzt werden.
Im ersten Schritt muss man aber die Geodaten mit in den View übernehmen. Theoretisch wäre es ausreichend das Geometrie Feld <strong>geltungsbereich</strong> zu nutzen. Wenn man aber etwas Interaktion haben will, z.B. eine Selektierbarkeit einzelner Objekte im Viewer, dann ist es besser, ein gesamtes Geometrieobjekt mit ausgewählten Attributen zu verwenden.
Hierzu überschreiben wir den die get_context_data Funktion der ListView um eine Serialisierung der Geoemtrien der aktuellen Seite und nennen sie <strong>markers</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.core.serializers</span><span class="w"> </span><span class="kn">import</span> <span class="n">serialize</span>
<span class="c1"># ...</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;markers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
            <span class="n">serialize</span><span class="p">(</span><span class="s2">&quot;geojson&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">object_list</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geometry_field</span><span class="o">=</span><span class="s1">&#39;geltungsbereich&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span>
</pre></div>
</div>
<p>Die Marker wollen wir in einem LeafletViewer darstellen. Hierzu müssen wir das Template bearbeiten. Aber zunächst brauchen wir noch die js-lib <strong>turf</strong>, die geometrische Operationen zur Verfügung stellt.</p>
<p>komserv/xplanung_light/templates/layout.html</p>
<div class="highlight-jinja notranslate"><div class="highlight"><pre><span></span><span class="x">&lt;!-- ... --&gt;</span>
<span class="x">&lt;head&gt;</span>
<span class="x">  &lt;!-- ... --&gt;</span>
<span class="x">  &lt;script src=&quot;https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js&quot;&gt;&lt;/script&gt;</span>
<span class="x">  &lt;!-- ... --&gt;</span>
<span class="x">&lt;/head&gt;</span>
<span class="x">&lt;!-- ... --&gt;</span>
</pre></div>
</div>
<p>komserv/xplanung_light/templates/xplanung_light/bplan_list.html</p>
<div class="highlight-jinja notranslate"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;xplanung_light/layout.html&quot;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">leaflet_tags</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}</span>
<span class="x">    Liste der Bebauungspläne</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">render_table</span> <span class="nv">from</span> <span class="nv">django_tables2</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="cp">{{</span> <span class="nv">markers</span><span class="o">|</span><span class="nf">json_script</span><span class="s2">:&quot;markers-data&quot;</span> <span class="cp">}}</span>
<span class="x">&lt;script&gt;</span>
<span class="x">&lt;!-- javascript-Part - siehe nächster Abschnitt --&gt;</span>
<span class="x">&lt;/script&gt;</span>
<span class="cp">{%</span> <span class="k">leaflet_map</span> <span class="s2">&quot;bplan_list_map&quot;</span> <span class="nv">callback</span><span class="o">=</span><span class="s2">&quot;window.map_init_basic&quot;</span> <span class="cp">%}</span>
<span class="x">&lt;p&gt;&lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;bplan-create&#39;</span> <span class="cp">%}</span><span class="x">&quot;&gt;BPlan anlegen&lt;/a&gt;&lt;/p&gt;</span>
<span class="cp">{%</span> <span class="k">render_table</span> <span class="nv">table</span> <span class="cp">%}</span>
<span class="x">&lt;p&gt;Anzahl: </span><span class="cp">{{</span> <span class="nv">object_list.count</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></div>
</div>
<p>In dem Javascript für den Leaflet-Client steckt jetzt etwas mehr Logik.</p>
<ul class="simple">
<li><p>Die marker werden in die das HTML-Element mit der id <strong>markers-data</strong> übetragen</p></li>
<li><p>Leaflet parsed das Json und baut daraus features</p></li>
<li><p>Die Features werden anhand von Attributen unterschiedlich gefärbt</p></li>
<li><p>Es gibt ein click-Event, dass die Polygone abfragt und ein PopUp erzeugt</p></li>
</ul>
<p>Javascript im Script-Tag des templates
komserv/xplanung_light/templates/xplanung_light/bplan_list.html</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">mapGlobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">map_init_basic</span><span class="w"> </span><span class="p">(</span><span class="nx">map</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">mapGlobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">map</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//https://stackoverflow.com/questions/43007019/leaflet-event-how-to-propagate-to-overlapping-layers</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;markers-data&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">markers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">textContent</span><span class="p">);</span>
<span class="w">        </span><span class="nx">map</span><span class="p">.</span><span class="nx">setZoom</span><span class="p">(</span><span class="mf">14</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">feature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">L</span><span class="p">.</span><span class="nx">geoJSON</span><span class="p">(</span><span class="nx">markers</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">style</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">feature</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">feature</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">planart</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;1000&#39;</span><span class="o">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;#ff0000&quot;</span><span class="p">};</span>
<span class="w">                        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;10000&#39;</span><span class="o">:</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;#0000ff&quot;</span><span class="p">};</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span><span class="c1">//,</span>
<span class="w">                </span><span class="c1">//onEachFeature: onEachFeature</span>
<span class="w">                </span><span class="c1">//zoomToBounds: zoomToBounds</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">            </span><span class="cm">/*.bindPopup(function (layer) {</span>
<span class="cm">                return layer</span>
<span class="cm">                    .feature.properties.generic_id;</span>
<span class="cm">            })*/</span>
<span class="w">        </span><span class="p">.</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span><span class="w">       </span>
<span class="w">        </span><span class="nx">map</span><span class="p">.</span><span class="nx">fitBounds</span><span class="p">(</span><span class="nx">feature</span><span class="p">.</span><span class="nx">getBounds</span><span class="p">());</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">        map.on(&#39;moveend&#39;, function() { </span>
<span class="cm">            const bbox_field = document.getElementById(&quot;id_bbox&quot;);</span>
<span class="cm">            //bbox_field.value = &quot;test&quot;;</span>
<span class="cm">            //alert(JSON.stringify(map.getBounds()));</span>
<span class="cm">            const bounds = map.getBounds();</span>
<span class="cm">            bbox_field.value = bounds._southWest.lng + &quot;,&quot; + bounds._southWest.lat + &quot;,&quot; + bounds._northEast.lng + &quot;,&quot; + bounds._northEast.lat;</span>
<span class="cm">       });</span>
<span class="cm">       */</span>
<span class="w">       </span><span class="cm">/*function onEachFeature(feature, layer) {</span>
<span class="cm">            layer.on({</span>
<span class="cm">                click: zoomToFeature</span>
<span class="cm">            });</span>
<span class="cm">            //featureByName[feature.properties.name] = layer;</span>
<span class="cm">        }*/</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">        function zoomToBounds(bounds) {</span>
<span class="cm">            alert(JSON.stringify(bounds));</span>
<span class="cm">            //featureByName[feature.properties.name] = layer;</span>
<span class="cm">        }</span>
<span class="cm">        */</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">        function zoomToFeature(e) {</span>
<span class="cm">            map.fitBounds(e.target.getBounds());</span>
<span class="cm">        }</span>
<span class="cm">        */</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">popup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">L</span><span class="p">.</span><span class="nx">popup</span><span class="p">()</span>
<span class="w">        </span><span class="nx">map</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">//var thisMap = map;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">lat</span><span class="p">,</span><span class="w"> </span><span class="nx">lng</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">latlng</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">turf</span><span class="p">.</span><span class="nx">point</span><span class="p">([</span><span class="nx">lng</span><span class="p">,</span><span class="w"> </span><span class="nx">lat</span><span class="p">]);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">polygonsClicked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">            </span><span class="c1">//console.log(map._layers)</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">map</span><span class="p">.</span><span class="nx">_layers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">layer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">map</span><span class="p">.</span><span class="nx">_layers</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">layer</span><span class="p">.</span><span class="nx">feature</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;undefined&quot;</span><span class="p">){</span>
<span class="w">                    </span><span class="c1">//map._layers.forEach((p, i) =&gt; {</span>
<span class="w">                    </span><span class="c1">//const polygon= p.toGeoJSON();</span>
<span class="w">                    </span><span class="kd">const</span><span class="w"> </span><span class="nx">polygon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">layer</span><span class="p">.</span><span class="nx">feature</span><span class="p">;</span>
<span class="w">                    </span><span class="c1">//console.log(polygon)</span>
<span class="w">                    </span><span class="c1">//console.log(point)</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">turf</span><span class="p">.</span><span class="nx">booleanPointInPolygon</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span><span class="w"> </span><span class="nx">polygon</span><span class="p">))</span><span class="w"> </span><span class="nx">polygonsClicked</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">layer</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">polygonsClicked</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">popupContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Dokument(e):&lt;br&gt;&quot;</span><span class="p">;</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">polygonsClicked</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">//console.log(polygonsClicked[id]);</span>
<span class="w">                    </span><span class="nx">bounds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">polygonsClicked</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">getBounds</span><span class="p">();</span>
<span class="w">                    </span><span class="c1">//console.log(bounds);</span>
<span class="w">                    </span><span class="nx">popupContent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">&quot;&lt;a onclick=&#39;mapGlobal.fitBounds([[&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">bounds</span><span class="p">.</span><span class="nx">_southWest</span><span class="p">.</span><span class="nx">lat</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;, &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">bounds</span><span class="p">.</span><span class="nx">_southWest</span><span class="p">.</span><span class="nx">lng</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;], [&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">bounds</span><span class="p">.</span><span class="nx">_northEast</span><span class="p">.</span><span class="nx">lat</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;, &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">bounds</span><span class="p">.</span><span class="nx">_northEast</span><span class="p">.</span><span class="nx">lng</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;]]);&#39;&gt;+&lt;/a&gt; &quot;</span><span class="p">;</span>
<span class="w">                    </span><span class="nx">popupContent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">&quot;&lt;b&gt;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">polygonsClicked</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">feature</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">title</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&lt;/b&gt; (&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">polygonsClicked</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">feature</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">date_of_document</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;) - &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">polygonsClicked</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">feature</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">description</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="s1">&#39;&lt;br&gt;&#39;</span><span class="p">;</span>
<span class="w">                    </span><span class="nx">popupContent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">&quot;&lt;a href=&#39;../&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">polygonsClicked</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">feature</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">pk</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;/pdf/&#39; target=&#39;_blank&#39;&gt;Download: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">polygonsClicked</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">feature</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">pk</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; (&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">polygonsClicked</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">feature</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">document_class</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;)&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&lt;/a&gt;&lt;br&gt;&quot;</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="nx">popup</span>
<span class="w">                    </span><span class="p">.</span><span class="nx">setLatLng</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">latlng</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="nx">setContent</span><span class="p">(</span><span class="nx">popupContent</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="nx">openOn</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="cm">/*</span>
<span class="cm">                popup</span>
<span class="cm">                .setLatLng(e.latlng)</span>
<span class="cm">                .setContent(&quot;You clicked the map at &quot; + e.latlng.toString())</span>
<span class="cm">                .openOn(map);</span>
<span class="cm">                */</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<p>Anpassung der Höhe im css-File</p>
<p>komserv/xplanung_light/static/xplanung_light/site.css</p>
<div class="highlight-css notranslate"><div class="highlight"><pre><span></span><span class="p">#</span><span class="nn">bplan_list_map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">height</span><span class="p">:</span><span class="w"> </span><span class="mi">180</span><span class="kt">px</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="suche">
<h1>Suche<a class="headerlink" href="#suche" title="Link to this heading"></a></h1>
<section id="installation-django-filter">
<h2>Installation django-filter<a class="headerlink" href="#installation-django-filter" title="Link to this heading"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">django</span><span class="o">-</span><span class="nb">filter</span>
</pre></div>
</div>
<p>komserv/settings.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ...</span>
<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="s1">&#39;django_filters&#39;</span><span class="p">,</span>
    <span class="c1"># ...</span>
<span class="p">]</span>
<span class="c1"># ...</span>
</pre></div>
</div>
</section>
<section id="erstellen-einer-filter-klasse">
<h2>Erstellen einer Filter Klasse<a class="headerlink" href="#erstellen-einer-filter-klasse" title="Link to this heading"></a></h2>
<p>komserv/xplanung_light/filters.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django_filters</span><span class="w"> </span><span class="kn">import</span> <span class="n">FilterSet</span><span class="p">,</span> <span class="n">CharFilter</span><span class="p">,</span> <span class="n">ModelChoiceFilter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">BPlan</span><span class="p">,</span> <span class="n">AdministrativeOrganization</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.gis.geos</span><span class="w"> </span><span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Q</span>

<span class="k">def</span><span class="w"> </span><span class="nf">bbox_filter</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="c1">#print(&quot;value from bbox_filter: &quot; + value)</span>
    <span class="c1"># extract bbox from cs numerical values</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="n">Polygon</span><span class="o">.</span><span class="n">from_bbox</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
    <span class="c1">#print(geom)</span>
    <span class="c1"># 7.51461,50.31417,7.51563,50.31544</span>
    <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">geltungsbereich__bboverlaps</span><span class="o">=</span><span class="n">geom</span><span class="p">)</span>


<span class="c1"># https://stackoverflow.com/questions/68592837/custom-filter-with-django-filters</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BPlanFilter</span><span class="p">(</span><span class="n">FilterSet</span><span class="p">):</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">CharFilter</span><span class="p">(</span><span class="n">lookup_expr</span><span class="o">=</span><span class="s1">&#39;icontains&#39;</span><span class="p">)</span>
    <span class="n">bbox</span> <span class="o">=</span> <span class="n">CharFilter</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;bbox_filter&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;BBOX&#39;</span><span class="p">)</span>
    <span class="n">gemeinde</span> <span class="o">=</span> <span class="n">ModelChoiceFilter</span><span class="p">(</span><span class="n">queryset</span><span class="o">=</span><span class="n">AdministrativeOrganization</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">))</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">BPlan</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;gemeinde&quot;</span><span class="p">,</span> <span class="s2">&quot;planart&quot;</span><span class="p">,</span> <span class="s2">&quot;bbox&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">bbox_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1">#print(&quot;name from DocumentFilter.bbox_filter: &quot; + name)</span>
        <span class="k">return</span> <span class="n">bbox_filter</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="anpassen-des-views">
<h2>Anpassen des Views<a class="headerlink" href="#anpassen-des-views" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Import der Klassen</p></li>
<li><p>Erben von FilterView</p></li>
<li><p>neues Attribut filterset_class</p></li>
<li><p>fixe Definition des templates - sonst sucht django nach bplan_filter.html - und das existiert nicht</p></li>
<li><p>Überschreiben von <strong>get_queryset</strong></p></li>
</ul>
<p>komserv/xplanung_light/views.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ...</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.filter</span><span class="w"> </span><span class="kn">import</span> <span class="n">BPlanFilter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django_filters.views</span><span class="w"> </span><span class="kn">import</span> <span class="n">FilterView</span>
<span class="c1"># ...</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BPlanListView</span><span class="p">(</span><span class="n">FilterView</span><span class="p">,</span> <span class="n">SingleTableView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">BPlan</span>
    <span class="n">table_class</span> <span class="o">=</span> <span class="n">BPlanTable</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;xplanung_light/bplan_list.html&#39;</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s2">&quot;bplan-list&quot;</span><span class="p">)</span> 
    <span class="n">filterset_class</span> <span class="o">=</span> <span class="n">BPlanFilter</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;markers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
            <span class="n">serialize</span><span class="p">(</span><span class="s2">&quot;geojson&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">object_list</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geometry_field</span><span class="o">=</span><span class="s1">&#39;geltungsbereich&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_set</span> <span class="o">=</span> <span class="n">BPlanFilter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="n">qs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_set</span><span class="o">.</span><span class="n">qs</span>
<span class="c1"># ...</span>
</pre></div>
</div>
</section>
<section id="anzeige-der-filterfunktionen-im-template">
<h2>Anzeige der Filterfunktionen im template<a class="headerlink" href="#anzeige-der-filterfunktionen-im-template" title="Link to this heading"></a></h2>
<div class="highlight-jinja notranslate"><div class="highlight"><pre><span></span><span class="x">&lt;!-- ... --&gt;</span>
<span class="cp">{%</span> <span class="k">leaflet_map</span> <span class="s2">&quot;bplan_list_map&quot;</span> <span class="nv">callback</span><span class="o">=</span><span class="s2">&quot;window.map_init_basic&quot;</span> <span class="cp">%}</span>
<span class="x">Filter</span>
<span class="x">&lt;!-- add boostrap form css - if wished --&gt;</span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">django_bootstrap5</span> <span class="cp">%}</span>
<span class="x">&lt;form method=&quot;get&quot; action=&quot;&quot;&gt;</span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">filter.form.as_p</span> <span class="cp">}}</span>
<span class="x">    &lt;input type=&quot;submit&quot; /&gt;&lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;bplan-list&#39;</span> <span class="cp">%}</span><span class="x">&quot;&gt;Filter löschen&lt;/a&gt;.&lt;/p&gt;</span>
<span class="x">&lt;/form&gt;</span>
<span class="x">&lt;p&gt;&lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;bplan-create&#39;</span> <span class="cp">%}</span><span class="x">&quot;&gt;BPlan anlegen&lt;/a&gt;&lt;/p&gt;</span>
<span class="x">&lt;!-- ... --&gt;</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="export_xml_1.html" class="btn btn-neutral float-left" title="XPlanung GML Export" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Zurück</a>
        <a href="result.html" class="btn btn-neutral float-right" title="Zusammenfassung" accesskey="n" rel="next">Weiter <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Armin Retterath.</p>
  </div>

  Erstellt mit <a href="https://www.sphinx-doc.org/">Sphinx</a> mit einem
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    bereitgestellt von <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>